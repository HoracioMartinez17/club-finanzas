// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Club - Sistema multi-tenant
model Club {
  id          String   @id @default(cuid())
  nombre      String
  slug        String   @unique  // Para URL: /sporting, /olimpia
  activo      Boolean  @default(true)
  planId      String   @default("free") // free, pro, enterprise
  logoUrl     String?
  createdBy   String?  // ID del super admin que lo creó
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  usuarios    User[]
  miembros    Miembro[]
  colectas    Colecta[]
  aportes     Aporte[]
  gastos      Gasto[]
  ingresos    Ingreso[]
  deudas      Deuda[]
  pagosDeuda  PagoDeuda[]
  config      Config?
  auditLogs   AuditLog[]

  @@map("clubes")
}

// Usuario - Directiva del club
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  nombre       String
  password     String
  rol          String   @default("admin") // admin, tesorero
  activo       Boolean  @default(true)
  isSuperAdmin Boolean  @default(false) // true = super admin (puede crear clubes)
  clubId       String?  // null para super admin, requerido para usuarios de club
  club         Club?    @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("users")
}

// Miembro del club
model Miembro {
  id                String   @id @default(cuid())
  nombre            String
  email             String?
  telefono          String?
  estado            String   @default("activo") // activo, inactivo
  deudaCuota        Float    @default(0)
  clubId            String
  club              Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relaciones
  aportes           Aporte[]
  gastosRealizados  Gasto[]
  ingresos          Ingreso[]
  deudas            Deuda[]

  @@map("miembros")
}

// Colecta especial
model Colecta {
  id          String   @id @default(cuid())
  nombre      String
  descripcion String?
  objetivo    Float
  estado      String   @default("activa") // activa, cerrada, completada
  fechaInicio DateTime @default(now())
  fechaCierre DateTime?
  clubId      String
  club        Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  aportes     Aporte[]
  gastos      Gasto[]

  @@map("colectas")
}

// Aporte de un miembro a una colecta (o aporte individual)
model Aporte {
  id            String   @id @default(cuid())
  colecta       Colecta? @relation(fields: [colectaId], references: [id], onDelete: Cascade)
  colectaId     String?
  miembro       Miembro? @relation(fields: [miembroId], references: [id], onDelete: SetNull)
  miembroId     String?
  miembroNombre String?  // Guardar nombre para historial
  cantidad      Float
  estado        String   @default("aportado") // aportado, comprometido
  metodoPago    String?  // efectivo, transferencia
  notas         String?
  clubId        String
  club          Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("aportes")
}

// Gasto general del club o de una colecta
model Gasto {
  id              String   @id @default(cuid())
  concepto        String
  cantidad        Float
  categoria       String   // jugadores, arbitros, viajes, cancha, etc
  quienPago       Miembro? @relation(fields: [quienPagoId], references: [id], onDelete: SetNull)
  quienPagoId     String?
  quienPagoNombre String?  // Guardar nombre para historial
  colecta         Colecta? @relation(fields: [colectaId], references: [id], onDelete: SetNull)
  colectaId       String?
  tipoGasto       String   @default("general") // general, colecta
  comprobante     String?  // URL del comprobante
  notas           String?
  clubId          String
  club            Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("gastos")
}

// Ingresos generales del club (cuotas, patrocinios, etc)
model Ingreso {
  id            String   @id @default(cuid())
  concepto      String   // cuota mensual, patrocinio, merchandising
  cantidad      Float
  fuente        String?
  miembro       Miembro? @relation(fields: [miembroId], references: [id], onDelete: SetNull)
  miembroId     String?
  miembroNombre String?  // Guardar nombre para historial
  fecha         DateTime @default(now())
  clubId        String
  club          Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("ingresos")
}

// Deudas del club hacia miembros
model Deuda {
  id              String   @id @default(cuid())
  miembro         Miembro? @relation(fields: [miembroId], references: [id], onDelete: Cascade)
  miembroId       String?
  miembroNombre   String?  // Para deudas generales (sin miembro específico)
  concepto        String   // comidas, transporte, préstamo, compra de equipos, etc
  montoOriginal   Float    // Monto total de la deuda
  montoPagado     Float    @default(0) // Cuánto se ha pagado hasta ahora
  montoRestante   Float    // Se calcula como montoOriginal - montoPagado
  estado          String   @default("pendiente") // pendiente, parcial_pagada, pagada
  fecha           DateTime @default(now())
  notas           String?
  clubId          String
  club            Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relaciones
  pagos           PagoDeuda[]

  @@map("deudas")
}

// Registro de pagos de deudas
model PagoDeuda {
  id        String   @id @default(cuid())
  deuda     Deuda    @relation(fields: [deudaId], references: [id], onDelete: Cascade)
  deudaId   String
  cantidad  Float
  fecha     DateTime @default(now())
  notas     String?
  clubId    String
  club      Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@map("pagos_deuda")
}

// Configuración de la app
model Config {
  id                  String  @id @default(cuid())
  transparenciaPublica Boolean @default(true) // true = mostrar detalles, false = ocultar
  nombreClub          String  @default("Club de Fútbol")
  descripcionClub     String?
  clubId              String   @unique
  club                Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@map("configs")
}

// Registro de auditoría para acciones críticas (seguridad)
model AuditLog {
  id            String   @id @default(cuid())
  clubId        String
  club          Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  userId        String?  // Usuario que realizó la acción (null para acciones del sistema)
  userName      String?  // Nombre del usuario para historial
  action        String   // Ej: USER_DELETE, USER_CREATE, PASSWORD_CHANGE, ROLE_CHANGE
  entityType    String   // Ej: User, Miembro, Deuda, Config
  entityId      String?  // ID de la entidad afectada
  details       String?  // JSON con detalles adicionales
  ipAddress     String?  // IP desde donde se realizó la acción
  userAgent     String?  // Navegador/dispositivo del usuario
  createdAt     DateTime @default(now())

  @@map("audit_logs")
  @@index([clubId, createdAt])
  @@index([userId, createdAt])
  @@index([action, createdAt])
}
